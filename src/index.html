<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <title>AI 虚拟人自动运营控制台</title>
    <style>
        :root {
            color-scheme: light dark;
            font-family: "PingFang SC", "Microsoft YaHei", system-ui, sans-serif;
            background: #f5f7fa;
        }
        body {
            margin: 0;
            padding: 2.5rem clamp(1rem, 3vw, 3rem);
            background: #f5f7fa;
            color: #1f2933;
        }
        h1 {
            margin-top: 0;
            font-size: clamp(1.8rem, 2.5vw, 2.6rem);
        }
        a.button, button {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.6rem 1.2rem;
            margin: 0.25rem 0.5rem 0.25rem 0;
            border-radius: 999px;
            border: 1px solid #2563eb;
            background: #2563eb;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: filter 0.2s ease;
        }
        a.button:hover, button:hover {
            filter: brightness(1.05);
        }
        section {
            background: rgba(255, 255, 255, 0.86);
            border-radius: 18px;
            padding: 1.5rem;
            margin-top: 1.8rem;
            box-shadow: 0 18px 38px rgba(15, 23, 42, 0.08);
        }
        .form-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1.2rem;
        }
        .form-grid {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }
        form {
            display: flex;
            flex-direction: column;
            gap: 0.9rem;
            background: rgba(248, 250, 252, 0.85);
            border-radius: 16px;
            padding: 1.25rem;
            box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.35);
        }
        form h3 {
            margin: 0;
        }
        label {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            font-size: 0.95rem;
        }
        label span {
            color: #334155;
            font-weight: 600;
        }
        input[type="text"],
        input[type="password"],
        textarea {
            border: 1px solid rgba(148, 163, 184, 0.6);
            border-radius: 12px;
            padding: 0.55rem 0.75rem;
            font: inherit;
            background: rgba(255, 255, 255, 0.92);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input[type="text"]:focus,
        input[type="password"]:focus,
        textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.18);
        }
        textarea {
            resize: vertical;
            min-height: 110px;
        }
        details {
            background: rgba(37, 99, 235, 0.06);
            border-radius: 12px;
            padding: 0.75rem 0.95rem;
        }
        details summary {
            cursor: pointer;
            font-weight: 600;
            color: #2563eb;
            margin-bottom: 0.6rem;
        }
        .hint {
            margin: 0;
            font-size: 0.85rem;
            color: #64748b;
        }
        pre {
            background: rgba(15, 23, 42, 0.85);
            color: #f8fafc;
            padding: 1rem;
            border-radius: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        ul {
            padding-left: 1.2rem;
            line-height: 1.65;
        }
        iframe {
            width: 100%;
            min-height: 520px;
            border: none;
            border-radius: 12px;
            box-shadow: inset 0 0 0 1px rgba(99, 102, 241, 0.25);
            background: #fff;
        }
        footer {
            margin-top: 2rem;
            font-size: 0.85rem;
            color: #64748b;
            text-align: center;
        }
    </style>
</head>
<body>
    <header>
        <h1>AI 虚拟人自动运营控制台</h1>
        <p>这里提供服务健康状态、最近任务与接口文档的快速入口，便于演示与调试。</p>
        <div>
            <a class="button" href="/docs" target="_blank" rel="noreferrer">打开交互式文档</a>
            <button id="refresh-health">刷新服务状态</button>
            <button id="trigger-run">手动触发流水线</button>
            <button id="load-history">查看最近发文记录</button>
        </div>
    </header>

    <section>
        <h2>服务状态</h2>
        <pre id="health">点击“刷新服务状态”以加载实时信息。</pre>
    </section>

    <section>
        <h2>AI 流水线配置</h2>
        <p>通过下方表单即可在线修改配置内容，提交后会写入覆盖文件并自动重新加载。</p>
        <div class="form-actions">
            <button id="load-settings-form" type="button">加载当前配置到表单</button>
            <button id="refresh-health-quick" type="button">刷新状态并同步表单</button>
        </div>
        <div class="form-grid">
            <form id="ai-form" autocomplete="off">
                <h3>流水线参数</h3>
                <label>
                    <span>是否启用自动发帖</span>
                    <input type="checkbox" name="enable" />
                </label>
                <label>
                    <span>每日发帖时段（逗号分隔，例如 11:00,19:00）</span>
                    <input type="text" name="post_slots" placeholder="11:00,19:00" />
                </label>
                <label>
                    <span>图片来源（replicate / leonardo / local）</span>
                    <input type="text" name="image_source" placeholder="replicate" />
                </label>
                <label>
                    <span>图像提示词模板</span>
                    <textarea name="prompt_template" rows="3" placeholder="portrait of ..."></textarea>
                </label>
                <label>
                    <span>文案风格标识</span>
                    <input type="text" name="caption_style" placeholder="soft_romance" />
                </label>
                <label>
                    <span>OpenAI API Key（会写入覆盖文件）</span>
                    <input type="password" name="openai_api_key" autocomplete="new-password" />
                </label>
                <details>
                    <summary>高级参数（可选）</summary>
                    <label>
                        <span>Replicate 模型</span>
                        <input type="text" name="replicate_model" placeholder="google/imagen-4" />
                    </label>
                    <label>
                        <span>Replicate 模型版本</span>
                        <input type="text" name="replicate_model_version" />
                    </label>
                    <label>
                        <span>Replicate Token</span>
                        <input type="password" name="replicate_token" autocomplete="new-password" />
                    </label>
                    <label>
                        <span>Leonardo 模型</span>
                        <input type="text" name="leonardo_model" />
                    </label>
                    <label>
                        <span>Leonardo Token</span>
                        <input type="password" name="leonardo_token" autocomplete="new-password" />
                    </label>
                    <label>
                        <span>流水线时区（例如 Asia/Shanghai）</span>
                        <input type="text" name="timezone" />
                    </label>
                </details>
                <button type="submit">保存流水线配置</button>
                <p class="hint">提交后会触发服务自动重载，请耐心等待提示。</p>
            </form>

            <form id="caption-form" autocomplete="off">
                <h3>文案提示词</h3>
                <label>
                    <span>使用的模型</span>
                    <input type="text" name="model" placeholder="gpt-4o-mini" />
                </label>
                <label>
                    <span>提示词正文</span>
                    <textarea name="prompt" rows="6" placeholder="请输入提示词内容"></textarea>
                </label>
                <label>
                    <span>模板列表（每行一个模板，可使用 {filename} 占位符）</span>
                    <textarea name="templates" rows="6"></textarea>
                </label>
                <details>
                    <summary>可选：指定外部文件</summary>
                    <label>
                        <span>提示词文件路径（留空代表移除）</span>
                        <input type="text" name="prompt_file" placeholder="data/caption_prompt.txt" />
                    </label>
                    <label>
                        <span>模板文件路径（留空代表移除）</span>
                        <input type="text" name="templates_file" placeholder="data/caption_templates.txt" />
                    </label>
                </details>
                <button type="submit">保存文案配置</button>
                <p class="hint">若只想清空外部文件，可直接留空并保存。</p>
            </form>
        </div>
    </section>

    <section>
        <h2>文案提示词预览</h2>
        <p>点击下方按钮即可查看当前的提示词与模板，便于在更新配置前了解现状。</p>
        <button id="load-caption-config">重新加载文案配置</button>
        <div id="caption-config">
            <p>尚未加载配置。</p>
        </div>
    </section>

    <section>
        <h2>最近发文记录</h2>
        <ul id="history-list"><li>点击“查看最近发文记录”获取最新数据。</li></ul>
    </section>

    <section>
        <h2>接口文档预览</h2>
        <iframe src="/docs" title="FastAPI 文档"></iframe>
    </section>

    <footer>如需更多高级功能，请直接使用顶部的交互式文档。</footer>

    <script>
    (function () {
        var healthOutput = document.querySelector('#health');
        var historyList = document.querySelector('#history-list');
        var captionConfig = document.querySelector('#caption-config');
        var aiForm = document.querySelector('#ai-form');
        var captionForm = document.querySelector('#caption-form');
        var loadSettingsButton = document.querySelector('#load-settings-form');
        var refreshHealthQuick = document.querySelector('#refresh-health-quick');

        function escapeHtml(value) {
            if (value === null || value === undefined) {
                return '';
            }
            var map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            };
            return String(value).replace(/[&<>"']/g, function (ch) {
                return map[ch] || ch;
            });
        }

        function showToast(message, type) {
            if (type === undefined) {
                type = 'info';
            }
            var toast = document.createElement('div');
            toast.textContent = message;
            toast.style.position = 'fixed';
            toast.style.right = '1.5rem';
            toast.style.bottom = '1.5rem';
            toast.style.padding = '0.75rem 1.2rem';
            toast.style.borderRadius = '999px';
            toast.style.fontWeight = '600';
            toast.style.background = type === 'error' ? '#ef4444' : '#10b981';
            toast.style.color = '#fff';
            toast.style.boxShadow = '0 18px 38px rgba(15, 23, 42, 0.18)';
            toast.style.zIndex = '9999';
            document.body.appendChild(toast);
            setTimeout(function () {
                toast.remove();
            }, 2600);
        }

        function fetchSettings() {
            return fetch('/settings/ai').then(function (resp) {
                if (!resp.ok) {
                    throw new Error('获取配置失败');
                }
                return resp.json();
            });
        }

        function fillAiForm(settings) {
            var ai = settings.ai_pipeline || {};
            aiForm.enable.checked = Boolean(ai.enable);
            aiForm.post_slots.value = Array.isArray(ai.post_slots) ? ai.post_slots.join(',') : '';
            aiForm.image_source.value = ai.image_source || '';
            aiForm.prompt_template.value = ai.prompt_template || '';
            aiForm.caption_style.value = ai.caption_style || '';
            aiForm.openai_api_key.value = ai.openai_api_key || '';
            aiForm.replicate_model.value = ai.replicate_model || '';
            aiForm.replicate_model_version.value = ai.replicate_model_version || '';
            aiForm.replicate_token.value = ai.replicate_token || '';
            aiForm.leonardo_model.value = ai.leonardo_model || '';
            aiForm.leonardo_token.value = ai.leonardo_token || '';
            aiForm.timezone.value = ai.timezone || '';
        }

        function fillCaptionForm(settings) {
            var caption = settings.caption || {};
            var promptField = captionForm.prompt;
            var templatesField = captionForm.templates;
            captionForm.model.value = caption.model || '';

            var promptValue = caption.prompt || '';
            promptField.value = promptValue;
            promptField.dataset.source = caption.prompt_file ? 'file' : 'inline';
            promptField.dataset.original = promptValue;

            var templates = Array.isArray(caption.templates) ? caption.templates : [];
            var templateValue = templates.join("\n");
            templatesField.value = templateValue;
            templatesField.dataset.source = caption.templates_file ? 'file' : 'inline';
            templatesField.dataset.original = templateValue;

            captionForm.prompt_file.value = caption.prompt_file || '';
            captionForm.templates_file.value = caption.templates_file || '';
        }

        function syncForms(showToastMessage) {
            if (showToastMessage === undefined) {
                showToastMessage = true;
            }
            return fetchSettings()
                .then(function (data) {
                    fillAiForm(data);
                    fillCaptionForm(data);
                    if (showToastMessage) {
                        showToast('配置已加载并同步到表单');
                    }
                    return data;
                })
                .catch(function (error) {
                    showToast('加载配置失败：' + error, 'error');
                    throw error;
                });
        }

        document.querySelector('#refresh-health').addEventListener('click', function () {
            healthOutput.textContent = '正在加载...';
            fetch('/health')
                .then(function (resp) {
                    return resp.json();
                })
                .then(function (data) {
                    healthOutput.textContent = JSON.stringify(data, null, 2);
                })
                .catch(function (error) {
                    healthOutput.textContent = '加载失败：' + error;
                });
        });

        refreshHealthQuick.addEventListener('click', function () {
            document.querySelector('#refresh-health').click();
            syncForms(false);
        });

        loadSettingsButton.addEventListener('click', function () {
            syncForms();
        });

        document.querySelector('#load-caption-config').addEventListener('click', function () {
            captionConfig.innerHTML = '<p>正在读取配置...</p>';
            syncForms(false)
                .then(function (data) {
                    var caption = data.caption || {};
                    var templates = Array.isArray(caption.templates) ? caption.templates : [];

                    var templateList;
                    if (templates.length > 0) {
                        templateList = '<ol>' + templates.map(function (item) {
                            return '<li>' + escapeHtml(item) + '</li>';
                        }).join('') + '</ol>';
                    } else {
                        templateList = '<p>当前未设置模板。</p>';
                    }

                    captionConfig.innerHTML =
                        '<p><strong>模型：</strong> ' + escapeHtml(caption.model || '未配置') + '</p>' +
                        '<p><strong>提示词：</strong></p>' +
                        '<pre>' + escapeHtml(caption.prompt || '未配置提示词') + '</pre>' +
                        '<p><strong>模板列表：</strong></p>' +
                        templateList;
                })
                .catch(function (error) {
                    captionConfig.innerHTML = '<p>读取失败：' + error + '</p>';
                });
        });

        aiForm.addEventListener('submit', function (event) {
            event.preventDefault();
            var slots = aiForm.post_slots.value
                .split(',')
                .map(function (item) {
                    return item.trim();
                })
                .filter(Boolean);
            var payload = {
                ai_pipeline: {
                    enable: aiForm.enable.checked,
                    post_slots: slots,
                    image_source: aiForm.image_source.value.trim() || null,
                    prompt_template: aiForm.prompt_template.value,
                    caption_style: aiForm.caption_style.value.trim() || null,
                    openai_api_key: aiForm.openai_api_key.value,
                    replicate_model: aiForm.replicate_model.value.trim() || null,
                    replicate_model_version: aiForm.replicate_model_version.value.trim() || null,
                    replicate_token: aiForm.replicate_token.value,
                    leonardo_model: aiForm.leonardo_model.value.trim() || null,
                    leonardo_token: aiForm.leonardo_token.value,
                    timezone: aiForm.timezone.value.trim() || null
                }
            };

            Object.keys(payload.ai_pipeline).forEach(function (key) {
                if (payload.ai_pipeline[key] === null) {
                    delete payload.ai_pipeline[key];
                }
            });

            fetch('/settings/ai', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
                .then(function (resp) {
                    if (!resp.ok) {
                        return resp.json().catch(function () {
                            return {};
                        }).then(function (error) {
                            throw new Error(error.detail || resp.statusText);
                        });
                    }
                    return resp.json();
                })
                .then(function (data) {
                    fillAiForm(data);
                    showToast('流水线配置已保存');
                })
                .catch(function (error) {
                    showToast('保存失败：' + error, 'error');
                });
        });

        captionForm.addEventListener('submit', function (event) {
            event.preventDefault();
            var promptField = captionForm.prompt;
            var templatesField = captionForm.templates;
            var templatesRaw = templatesField.value;
            var templates = templatesRaw
                .split('
')
                .map(function (item) {
                    return item.trim();
                })
                .filter(Boolean);
            var captionPayload = {
                model: captionForm.model.value.trim() || null,
                prompt: promptField.value,
                templates: templates,
                prompt_file: captionForm.prompt_file.value.trim(),
                templates_file: captionForm.templates_file.value.trim()
            };

            if (captionPayload.prompt_file) {
                if (
                    promptField.dataset.source === 'file' &&
                    promptField.dataset.original !== undefined &&
                    promptField.value === promptField.dataset.original
                ) {
                    delete captionPayload.prompt;
                }
            }

            if (captionPayload.templates_file) {
                if (
                    templatesField.dataset.source === 'file' &&
                    templatesField.dataset.original !== undefined &&
                    templatesRaw === templatesField.dataset.original
                ) {
                    delete captionPayload.templates;
                }
            }

            if (!captionPayload.prompt_file) {
                captionPayload.prompt_file = null;
            }
            if (!captionPayload.templates_file) {
                captionPayload.templates_file = null;
            }

            var payload = { caption: captionPayload };

            fetch('/settings/ai', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
                .then(function (resp) {
                    if (!resp.ok) {
                        return resp.json().catch(function () {
                            return {};
                        }).then(function (error) {
                            throw new Error(error.detail || resp.statusText);
                        });
                    }
                    return resp.json();
                })
                .then(function (data) {
                    fillCaptionForm(data);
                    showToast('文案配置已保存');
                })
                .catch(function (error) {
                    showToast('保存失败：' + error, 'error');
                });
        });

        document.querySelector('#trigger-run').addEventListener('click', function () {
            fetch('/pipeline/run', { method: 'POST' })
                .then(function (resp) {
                    return resp.json();
                })
                .then(function (data) {
                    showToast(data.message || '流水线任务已提交');
                    if (data.note) {
                        showToast(data.note, 'error');
                    }
                })
                .catch(function (error) {
                    showToast('触发失败：' + error, 'error');
                });
        });

        document.querySelector('#load-history').addEventListener('click', function () {
            historyList.innerHTML = '<li>正在读取...</li>';
            fetch('/posts/history?limit=10')
                .then(function (resp) {
                    return resp.json();
                })
                .then(function (data) {
                    if (!data.items || data.items.length === 0) {
                        historyList.innerHTML = '<li>暂无记录。</li>';
                        return;
                    }
                    historyList.innerHTML = data.items.map(function (item) {
                        var createdAt = item.created_at || item.createdAt || item.created || '未知时间';
                        var caption = item.caption || '（无文案）';
                        return '<li><strong>' + createdAt + '</strong> - ' + caption + '</li>';
                    }).join('');
                })
                .catch(function (error) {
                    historyList.innerHTML = '<li>读取失败：' + error + '</li>';
                });
        });

        syncForms(false).catch(function () {});
    })();
    </script>
</body>
</html>
